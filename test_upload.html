<!DOCTYPE html>
<html>
<head>
    <title>Pupper Image Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input, textarea, button { margin: 5px 0; padding: 8px; width: 100%; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .response { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üêï Pupper Image Upload Test</h1>
    
    <div class="step">
        <h3>Step 1: Select Image & Get Presigned URL</h3>
        <input type="file" id="imageFile" accept="image/*" />
        <button onclick="getPresignedUrl()">Get Upload URL</button>
        <div id="step1Response" class="response" style="display:none;"></div>
    </div>

    <div class="step">
        <h3>Step 2: Upload Image to S3</h3>
        <button id="uploadBtn" onclick="uploadImage()" disabled>Upload Image to S3</button>
        <div id="step2Response" class="response" style="display:none;"></div>
    </div>

    <div class="step">
        <h3>Step 3: Complete Dog Registration</h3>
        <input type="text" id="shelter" placeholder="Shelter Name" value="Happy Paws Shelter" />
        <input type="text" id="city" placeholder="City" value="Seattle" />
        <input type="text" id="state" placeholder="State" value="WA" />
        <input type="text" id="dogName" placeholder="Dog Name" value="Buddy" />
        <input type="text" id="dogSpecies" placeholder="Dog Species" value="Labrador Retriever" />
        <textarea id="dogDescription" placeholder="Dog Description">Friendly and energetic dog looking for a loving home.</textarea>
        <button id="completeBtn" onclick="completeRegistration()" disabled>Complete Registration</button>
        <div id="step3Response" class="response" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'https://3wfbfr7110.execute-api.us-east-1.amazonaws.com/prod';
        let uploadUrl = '';
        let s3Key = '';

        async function getPresignedUrl() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image file first!');
                return;
            }

            const requestData = {
                filename: file.name,
                file_size: file.size,
                content_type: file.type
            };

            try {
                const response = await fetch(`${API_BASE}/upload/presigned`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                const responseDiv = document.getElementById('step1Response');
                
                if (response.ok) {
                    uploadUrl = data.upload_url;
                    s3Key = data.s3_key;
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `‚úÖ Success! Got presigned URL<br>S3 Key: ${s3Key}`;
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Error: ${data.error || 'Unknown error'}`;
                }
                responseDiv.style.display = 'block';
            } catch (error) {
                document.getElementById('step1Response').innerHTML = `‚ùå Network Error: ${error.message}`;
                document.getElementById('step1Response').style.display = 'block';
            }
        }

        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            try {
                console.log('Upload URL:', uploadUrl);
                console.log('File type:', file.type);
                console.log('File size:', file.size);
                
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type },
                    body: file
                });

                const responseDiv = document.getElementById('step2Response');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = '‚úÖ Image uploaded successfully to S3!';
                    document.getElementById('completeBtn').disabled = false;
                } else {
                    const errorText = await response.text();
                    console.log('S3 Error Response:', errorText);
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Upload failed: ${response.status} ${response.statusText}<br>Details: ${errorText}`;
                }
                responseDiv.style.display = 'block';
            } catch (error) {
                console.log('Upload Error:', error);
                document.getElementById('step2Response').innerHTML = `‚ùå Upload Error: ${error.message}`;
                document.getElementById('step2Response').style.display = 'block';
            }
        }

        async function completeRegistration() {
            const dogData = {
                s3_key: s3Key,
                shelter: document.getElementById('shelter').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                dog_name: document.getElementById('dogName').value,
                dog_species: document.getElementById('dogSpecies').value,
                dog_description: document.getElementById('dogDescription').value
            };

            try {
                const response = await fetch(`${API_BASE}/upload/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dogData)
                });

                const data = await response.json();
                const responseDiv = document.getElementById('step3Response');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `‚úÖ Dog registered successfully!<br>Dog ID: ${data.dog_id}<br>Image URL: ${data.image_url}`;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Registration failed: ${data.error || 'Unknown error'}`;
                }
                responseDiv.style.display = 'block';
            } catch (error) {
                document.getElementById('step3Response').innerHTML = `‚ùå Registration Error: ${error.message}`;
                document.getElementById('step3Response').style.display = 'block';
            }
        }
    </script>
</body>
</html>